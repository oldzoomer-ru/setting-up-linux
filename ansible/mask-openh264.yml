---
- name: Disable OpenH264 repository and mask it in Flatpak (system-wide)
  hosts: all
  become: yes
  vars:
    openh264_flatpak_id: org.freedesktop.Platform.openh264
  tasks:
    - name: Disable OpenH264 via dnf config-manager
      command: dnf config-manager setopt fedora-cisco-openh264.enabled=0
      when: ansible_distribution == "Fedora"
      changed_when: false

    - name: Check if Flatpak is installed
      package_facts:
        manager: auto
      changed_when: false

    - name: Mask OpenH264 in Flatpak (system-wide)
      command:
        cmd: flatpak mask {{ openh264_flatpak_id }} --system
      environment:
        LANG: C.UTF-8
      register: flatpak_mask_result
      changed_when: "'nothing to mask' not in flatpak_mask_result.stderr"
      failed_when: flatpak_mask_result.rc not in [0, 1]  # rc=1 may mean already masked
      when:
        - "'flatpak' in ansible_facts.packages"
        - ansible_virtualization_type != "docker"  # avoid in containers unless needed
