---
- name: "LVM Fortress with Per-User Data"
  hosts: all
  become: yes
  vars:
    target_user: "{{ ansible_user_id }}"
    vg_name: "vg0"
    data_mount: "/mnt/data"
    user_data_path: "{{ data_mount }}/{{ ansible_user_id }}"
    # Резервируем под снапшот системы чуть больше для обновлений
    root_snap_size: "20G"
    home_snap_size: "10G"

  tasks:
    - name: 1. Установка etckeeper и auditd
      apt:
        name: [etckeeper, auditd]
        state: present
        update_cache: yes

    - name: 2. Настройка прав доступа на корень хранилища Data
      file:
        path: "{{ data_mount }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: 3. Создание изолированного хранилища пользователя на Data
      file:
        path: "{{ user_data_path }}"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0700'

    - name: 4. Структура папок пользователя (XDG)
      become_user: "{{ target_user }}"
      file:
        path: "{{ user_data_path }}/{{ item }}"
        state: directory
        mode: '0755'
      loop: [Documents, Pictures, Videos, Downloads, Music]

    - name: 5. Перенос путей XDG на раздел Data
      become_user: "{{ target_user }}"
      lineinfile:
        path: "~/.config/user-dirs.dirs"
        regexp: "^XDG_{{ item.key }}_DIR="
        line: 'XDG_{{ item.key }}_DIR="{{ user_data_path }}/{{ item.value }}"'
        create: yes
      loop:
        - { key: 'DOCUMENTS', value: 'Documents' }
        - { key: 'PICTURES', value: 'Pictures' }
        - { key: 'VIDEOS', value: 'Videos' }
        - { key: 'MUSIC', value: 'Music' }
        - { key: 'DOWNLOAD', value: 'Downloads' }

    - name: 6. Правила Auditd (Ловим мусор в Home в реальном времени)
      copy:
        dest: /etc/audit/rules.d/home_audit.rules
        content: |
          # Игнорируем кэш
          -e /home/{{ target_user }}/.cache/
          # Следим за конфигами (LV home)
          -w /home/{{ target_user }}/.config/ -p wa -k dotfiles_change
          -w /home/{{ target_user }}/.local/ -p wa -k dotfiles_change
          # Следим за мусором в корне домашней папки
          -w /home/{{ target_user }}/ -p wa -k home_root_polution
      notify: Reload Auditd

    - name: 7. Настройка LVM Auto-extend (Авто-расширение снапшотов)
      lineinfile:
        path: /etc/lvm/lvm.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: 'snapshot_autoextend_threshold =', line: '    snapshot_autoextend_threshold = 70' }
        - { regexp: 'snapshot_autoextend_percent =', line: '    snapshot_autoextend_percent = 20' }

    - name: 8. Пульт управления для смартфона (Bash Aliases)
      blockinfile:
        path: "/home/{{ target_user }}/.bashrc"
        marker: "# {mark} LVM & AUDIT CONTROL"
        block: |
          # --- ТОЧКИ ОТКАТА ---
          # Создать снапшоты системы и конфигов перед экспериментом
          alias snap-pre='sudo lvcreate -s -n root_pre -L {{ root_snap_size }} /dev/{{ vg_name }}/root && sudo lvcreate -s -n home_pre -L {{ home_snap_size }} /dev/{{ vg_name }}/home'
          # Проверить статус (сколько места занято в снапшоте)
          alias snap-ls='sudo lvs -o lv_name,lv_size,data_percent,snap_percent'
          # Удалить точки отката (если всё прошло успешно)
          alias snap-rm='sudo lvremove -f /dev/{{ vg_name }}/root_pre /dev/{{ vg_name }}/home_pre'
          
          # --- ОТКАТЫ ---
          # Откат конфигов (Home) - выполняется сразу
          alias snap-rollback-home='sudo lvconvert --merge /dev/{{ vg_name }}/home_pre'
          # Откат СИСТЕМЫ (Root) - выполнится после перезагрузки
          alias snap-rollback-root='echo "СИСТЕМА БУДЕТ ОТКАТАНА ПОСЛЕ REBOOT"; sudo lvconvert --merge /dev/{{ vg_name }}/root_pre && sudo reboot'
          
          # --- АУДИТ ---
          # Кто мусорил в конфигах сегодня?
          alias audit-check='sudo ausearch -k dotfiles_change -ts today -i'
          # Кто создал папки в корне Home?
          alias audit-trash='sudo ausearch -k home_root_polution -i'

    - name: 9. Инициализация etckeeper для /etc
      command: etckeeper init
      args:
        creates: /etc/.git

  handlers:
    - name: Reload Auditd
      service:
        name: auditd
        state: restarted
