---
- name: Install CUDA Toolkit and NVIDIA driver
  hosts: all
  become: yes
  vars:
    os_id: "{{ ansible_distribution | lower }}"
    os_major: "{{ ansible_distribution_version.split('.')[0] }}"

    # Маппинг мажорной версии Mint → Ubuntu numeric ID
    mint_to_ubuntu:
      '20': '2004'
      '21': '2204'
      '22': '2404'

    # Определяем целевую ОС
    target_os: >-
      {{
        'ubuntu' if os_id in ['linux mint', 'ubuntu']
        else ('debian' if os_id == 'debian' else '')
      }}

    # Определяем numeric release (2004, 2204, 2404, 12 и т.д.)
    target_release_numeric: >-
      {{
        mint_to_ubuntu[os_major]
        if os_id == 'linux mint'
        else (
          (ansible_distribution_version.split('.')[0] + ansible_distribution_version.split('.')[1])
          if os_id == 'ubuntu'
          else ansible_distribution_major_version
        )
      }}

    os_repo_suffix: "{{ target_os }}{{ target_release_numeric }}"
    cuda_keyring_url: "https://developer.download.nvidia.com/compute/cuda/repos/{{ os_repo_suffix }}/x86_64/cuda-keyring_1.1-1_all.deb"

  tasks:
    - name: Fail on unsupported OS
      assert:
        that:
          - target_os in ['ubuntu', 'debian']
          - target_release_numeric | length > 0
        fail_msg: "Only Ubuntu, Debian, and Linux Mint (based on supported Ubuntu) are supported"

    - name: Install prerequisites
      apt:
        name:
          - wget
          - ca-certificates
          - gnupg
        state: present
        update_cache: yes

    - name: Download cuda-keyring
      get_url:
        url: "{{ cuda_keyring_url }}"
        dest: /tmp/cuda-keyring.deb
        mode: '0644'

    - name: Install cuda-keyring
      apt:
        deb: /tmp/cuda-keyring.deb
        state: present

    - name: Install CUDA meta-package
      apt:
        name: cuda
        state: present
        update_cache: yes

    - name: Enable NVIDIA power management services (if available)
      systemd:
        name: "{{ item }}"
        enabled: yes
        daemon_reload: yes
      loop:
        - nvidia-suspend
        - nvidia-hibernate
        - nvidia-resume
      ignore_errors: yes

    - name: Set global environment for CUDA
      lineinfile:
        path: /etc/profile.d/cuda.sh
        line: "{{ item }}"
        create: yes
        state: present
      loop:
        - 'PATH="/usr/local/cuda/bin:$PATH"'
        - 'LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"'
