---
- name: Universal System Configuration Playbook
  hosts: all
  become: yes
  vars:
    chrome_url:
      Debian: "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
      RedHat: "https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm"

    rpmfusion_free_url: >-
      {{
        'https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-' + ansible_distribution_major_version + '.noarch.rpm'
        if ansible_distribution == 'Fedora'
        else 'https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-' + ansible_distribution_major_version + '.noarch.rpm'
      }}
    rpmfusion_nonfree_url: >-
      {{
        'https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-' + ansible_distribution_major_version + '.noarch.rpm'
        if ansible_distribution == 'Fedora'
        else 'https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-' + ansible_distribution_major_version + '.noarch.rpm'
      }}

    epel_url: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"

    multimedia_packages_debian:
      - ffmpeg
      - gstreamer1.0-plugins-base
      - gstreamer1.0-plugins-good
      - gstreamer1.0-plugins-bad
      - gstreamer1.0-plugins-ugly
      - gstreamer1.0-libav
      - libavcodec-extra

    multimedia_packages_redhat:
      - ffmpeg
      - gstreamer1-plugins-ugly
      - gstreamer1-plugins-bad-free
      - gstreamer1-plugins-bad-freeworld
      - gstreamer1-plugins-good
      - gstreamer1-plugins-base

  tasks:
    # === Flatpak ===
    - name: Install Flatpak and add Flathub
      when: ansible_os_family in ['Debian', 'RedHat']
      block:
        - name: Install flatpak package
          ansible.builtin.package:
            name: flatpak
            state: present

        - name: Add Flathub remote
          community.general.flatpak_remote:
            name: flathub
            flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
            state: present

    # === Google Chrome ===
    - name: Install Google Chrome
      when: ansible_os_family in ['Debian', 'RedHat']
      block:
        - name: Download Chrome package
          ansible.builtin.get_url:
            url: "{{ chrome_url[ansible_os_family] }}"
            dest: "/tmp/google-chrome-stable.{{ 'deb' if ansible_os_family == 'Debian' else 'rpm' }}"
            mode: '0644'

        - name: Install Chrome on Debian-based systems
          ansible.builtin.apt:
            deb: "/tmp/google-chrome-stable.deb"
          when: ansible_os_family == 'Debian'

        - name: Install Chrome on RedHat-based systems
          ansible.builtin.dnf:
            name: "/tmp/google-chrome-stable.rpm"
            disable_gpg_check: true
            state: present
          when: ansible_distribution == "Fedora"

    # === Microsoft Core Fonts ===
    - name: Accept MS fonts EULA on Debian-based systems
      ansible.builtin.debconf:
        name: ttf-mscorefonts-installer
        question: msttcorefonts/accepted-mscorefonts-eula
        value: "true"
        vtype: select
      when: ansible_os_family == 'Debian'

    - name: Install Microsoft Core Fonts
      when: ansible_os_family in ['Debian', 'RedHat']
      block:
        - name: Install via APT (Debian/Ubuntu)
          ansible.builtin.apt:
            name: ttf-mscorefonts-installer
            state: present
            update_cache: yes
          when: ansible_os_family == 'Debian'

    # === Extra Repositories for RedHat family ===
    - name: Configure additional repositories (RHEL/Fedora)
      when: ansible_os_family == 'RedHat'
      block:
        - name: Install EPEL (RHEL/CentOS only)
          ansible.builtin.dnf:
            name: "{{ epel_url }}"
            state: present
            disable_gpg_check: yes
          when: ansible_distribution != 'Fedora'

        - name: Install RPM Fusion Free repository
          ansible.builtin.dnf:
            name: "{{ rpmfusion_free_url }}"
            state: present
            disable_gpg_check: yes

        - name: Install RPM Fusion Non-Free repository
          ansible.builtin.dnf:
            name: "{{ rpmfusion_nonfree_url }}"
            state: present
            disable_gpg_check: yes

        - name: Refresh DNF cache
          ansible.builtin.dnf:
            update_cache: yes

    # === Multimedia Codecs ===
    - name: Install multimedia codecs on Debian-based systems
      ansible.builtin.apt:
        name: "{{ multimedia_packages_debian }}"
        state: present
      when: ansible_os_family == 'Debian'

    - name: Install multimedia codecs on RedHat-based systems
      ansible.builtin.dnf:
        name: "{{ multimedia_packages_redhat }}"
        state: present
        allowerasing: true
      when: ansible_os_family == 'RedHat'
